<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Location Finder</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 50px auto;
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 30px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: block;
      margin: 0 auto;
      transition: transform 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .result {
      margin-top: 30px;
      display: none;
    }

    .info-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }

    .info-box {
      background: #f7f9fc;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .label {
      font-size: 12px;
      color: #667eea;
      font-weight: 600;
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    .value {
      font-size: 16px;
      color: #333;
      word-break: break-all;
    }

    .copy-btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 5px 12px;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 10px;
    }

    .copy-btn:hover {
      background: #5568d3;
    }

    #map {
      width: 100%;
      height: 350px;
      margin-top: 20px;
      border-radius: 10px;
      border: 1px solid #ccc;
    }

    .loading {
      text-align: center;
      color: #667eea;
      margin-top: 20px;
      display: none;
      font-size: 16px;
      font-weight: 600;
    }

    .error {
      background: #fee;
      color: #c33;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      border-left: 4px solid #f5576c;
    }

    .success {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 10px 15px;
      border-radius: 8px;
      margin-top: 10px;
      border-left: 4px solid #4caf50;
      font-size: 14px;
    }

    .map-links {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .map-link {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 14px;
      transition: background 0.2s;
    }

    .map-link:hover {
      background: #45a049;
    }

    .speed-alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff5722;
      color: white;
      padding: 15px 30px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      box-shadow: 0 5px 20px rgba(255, 87, 34, 0.5);
      z-index: 10000;
      animation: slideDown 0.3s ease-out;
      transition: opacity 0.3s;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100px);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    .retry-btn {
      background: #ff9800;
      margin-top: 15px;
    }

    .retry-btn:hover {
      background: #f57c00;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìç Find My Location</h1>
    <p class="subtitle">Discover your current GPS coordinates with accuracy information</p>
    
    <button id="mainBtn" onclick="getLocation()">Get My Location</button>
    
    <div class="loading" id="loading">
      üîÑ Getting your location...
    </div>
    
    <div class="result" id="result"></div>
  </div>

  <script>
    let watchId = null;
    let lastPosition = null;
    let lastTime = null;
    let isTracking = false;
    let zeroSpeedStartTime = null;
    let notificationSent = false;
    let notificationCheckInterval = null;
    let retryCount = 0;
    const MAX_RETRIES = 3;

    // Request notification permission on page load
    window.addEventListener('load', () => {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    });

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showSuccessMessage('‚úÖ Copied: ' + text);
      }).catch(() => {
        alert('‚úÖ Copied: ' + text);
      });
    }

    function showSuccessMessage(message) {
      const successDiv = document.createElement('div');
      successDiv.className = 'success';
      successDiv.textContent = message;
      document.querySelector('.container').appendChild(successDiv);
      
      setTimeout(() => {
        successDiv.style.opacity = '0';
        setTimeout(() => successDiv.remove(), 300);
      }, 2000);
    }

    function getLocation() {
      const loading = document.getElementById('loading');
      const result = document.getElementById('result');
      const mainBtn = document.getElementById('mainBtn');
      
      if (!navigator.geolocation) {
        result.innerHTML = '<div class="error">‚ùå Geolocation is not supported by your browser.</div>';
        result.style.display = 'block';
        return;
      }

      mainBtn.disabled = true;
      loading.style.display = 'block';
      result.style.display = 'none';

      // Increased timeout and added better options
      const options = {
        enableHighAccuracy: true,
        timeout: 30000, // Increased to 30 seconds
        maximumAge: 5000 // Cache for 5 seconds
      };

      navigator.geolocation.getCurrentPosition(
        (position) => {
          retryCount = 0; // Reset retry count on success
          showPosition(position);
          mainBtn.disabled = false;
        },
        (error) => {
          showError(error);
          mainBtn.disabled = false;
        },
        options
      );
    }

    function retryGetLocation() {
      if (retryCount < MAX_RETRIES) {
        retryCount++;
        console.log(`Retry attempt ${retryCount} of ${MAX_RETRIES}`);
        getLocation();
      } else {
        const result = document.getElementById('result');
        result.innerHTML += '<div class="error">‚ùå Maximum retry attempts reached. Please check your GPS and internet connection.</div>';
      }
    }

    function toggleSpeedTracking() {
      const button = event.target;
      
      if (!isTracking) {
        // Request notification permission if not granted
        if ('Notification' in window && Notification.permission === 'default') {
          Notification.requestPermission();
        }
        
        // Start tracking
        isTracking = true;
        button.textContent = '‚è∏Ô∏è Stop Speed Tracking';
        button.style.background = '#f44336';
        lastPosition = null;
        lastTime = null;
        zeroSpeedStartTime = null;
        notificationSent = false;
        
        const options = {
          enableHighAccuracy: true,
          timeout: 30000,
          maximumAge: 0
        };
        
        watchId = navigator.geolocation.watchPosition(updateSpeed, handleSpeedError, options);
        
        // Start checking for zero speed
        notificationCheckInterval = setInterval(checkZeroSpeedNotification, 1000);
      } else {
        // Stop tracking
        isTracking = false;
        button.textContent = 'üöÄ Start Speed Tracking';
        button.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        
        if (watchId !== null) {
          navigator.geolocation.clearWatch(watchId);
          watchId = null;
        }
        
        if (notificationCheckInterval !== null) {
          clearInterval(notificationCheckInterval);
          notificationCheckInterval = null;
        }
        
        zeroSpeedStartTime = null;
        notificationSent = false;
      }
    }

    function handleSpeedError(error) {
      console.error('Speed tracking error:', error);
      // Don't stop tracking on timeout, just log it
      if (error.code !== error.TIMEOUT) {
        showError(error);
      }
    }

    function checkZeroSpeedNotification() {
      if (!isTracking) return;
      
      const speedDisplay = document.getElementById('speed-display');
      if (!speedDisplay) return;
      
      const speedText = speedDisplay.textContent;
      const speedMatch = speedText.match(/(\d+\.\d+)\s*m\/s/);
      
      if (speedMatch) {
        const currentSpeed = parseFloat(speedMatch[1]);
        
        if (currentSpeed === 0 || currentSpeed < 0.5) {
          // Speed is zero or very low
          if (zeroSpeedStartTime === null) {
            zeroSpeedStartTime = Date.now();
          } else {
            const elapsed = (Date.now() - zeroSpeedStartTime) / 1000;
            
            if (elapsed >= 5 && !notificationSent) {
              sendZeroSpeedNotification();
              notificationSent = true;
            }
          }
        } else {
          // Speed is not zero, reset
          zeroSpeedStartTime = null;
          notificationSent = false;
        }
      }
    }

    function sendZeroSpeedNotification() {
      // Try browser notification
      if ('Notification' in window && Notification.permission === 'granted') {
        const notification = new Notification('‚ö†Ô∏è Speed Alert', {
          body: 'Your speed has been zero for 5 seconds!',
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">‚ö†Ô∏è</text></svg>',
          badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">‚ö†Ô∏è</text></svg>',
          tag: 'zero-speed-alert',
          requireInteraction: false,
          vibrate: [200, 100, 200]
        });
        
        notification.onclick = () => {
          window.focus();
          notification.close();
        };
        
        // Auto close after 5 seconds
        setTimeout(() => notification.close(), 5000);
      }
      
      // Also show in-app alert
      showInAppAlert();
      
      // Vibrate if supported
      if ('vibrate' in navigator) {
        navigator.vibrate([200, 100, 200, 100, 200]);
      }
    }

    function showInAppAlert() {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'speed-alert';
      alertDiv.innerHTML = '‚ö†Ô∏è Speed has been zero for 5 seconds!';
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 300);
      }, 4000);
    }

    function updateSpeed(position) {
      const currentTime = position.timestamp;
      const currentLat = position.coords.latitude;
      const currentLng = position.coords.longitude;
      
      let speed = 0;
      let speedKmh = 0;
      let speedMph = 0;
      
      // Use native speed if available
      if (position.coords.speed !== null && position.coords.speed >= 0) {
        speed = position.coords.speed; // meters per second
        speedKmh = (speed * 3.6).toFixed(2);
        speedMph = (speed * 2.23694).toFixed(2);
      } else if (lastPosition !== null && lastTime !== null) {
        // Calculate speed manually
        const timeDiff = (currentTime - lastTime) / 1000; // seconds
        
        if (timeDiff > 0) {
          const distance = calculateDistance(
            lastPosition.lat,
            lastPosition.lng,
            currentLat,
            currentLng
          );
          
          speed = distance / timeDiff; // meters per second
          speedKmh = (speed * 3.6).toFixed(2);
          speedMph = (speed * 2.23694).toFixed(2);
        }
      }
      
      lastPosition = { lat: currentLat, lng: currentLng };
      lastTime = currentTime;
      
      // Update speed display
      const speedBox = document.getElementById('speed-display');
      if (speedBox) {
        speedBox.innerHTML = `
          <div class="info-box">
            <div class="label">Current Speed</div>
            <div class="value">
              ${speed.toFixed(2)} m/s | ${speedKmh} km/h | ${speedMph} mph
            </div>
          </div>
        `;
      }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      // Haversine formula to calculate distance between two points
      const R = 6371e3; // Earth's radius in meters
      const œÜ1 = lat1 * Math.PI / 180;
      const œÜ2 = lat2 * Math.PI / 180;
      const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
      const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

      const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                Math.cos(œÜ1) * Math.cos(œÜ2) *
                Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

      return R * c; // Distance in meters
    }

    function showPosition(position) {
      const loading = document.getElementById('loading');
      const result = document.getElementById('result');
      
      loading.style.display = 'none';
      result.style.display = 'block';

      const lat = position.coords.latitude.toFixed(6);
      const lng = position.coords.longitude.toFixed(6);
      const accuracy = position.coords.accuracy.toFixed(2);
      
      let html = '<div class="info-grid">';
      
      html += `
        <div class="info-box">
          <div class="label">Latitude</div>
          <div class="value">${lat} <button class="copy-btn" onclick="copyToClipboard('${lat}')">Copy</button></div>
        </div>
        <div class="info-box">
          <div class="label">Longitude</div>
          <div class="value">${lng} <button class="copy-btn" onclick="copyToClipboard('${lng}')">Copy</button></div>
        </div>
        <div class="info-box">
          <div class="label">Accuracy</div>
          <div class="value">${accuracy} meters</div>
        </div>
      `;

      if (position.coords.altitude) {
        html += `
          <div class="info-box">
            <div class="label">Altitude</div>
            <div class="value">${position.coords.altitude.toFixed(2)} meters</div>
          </div>
        `;
      }

      html += '</div>';

      // Add speed tracking button and display
      html += `
        <button onclick="toggleSpeedTracking()" style="margin: 20px auto; display: block;">
          üöÄ Start Speed Tracking
        </button>
        <div id="speed-display"></div>
      `;

      // Add map links
      html += '<div class="map-links">';
      html += `<a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="map-link">üó∫Ô∏è Open in Google Maps</a>`;
      html += `<a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}&zoom=15" target="_blank" class="map-link">üåç OpenStreetMap</a>`;
      html += '</div>';

      // Embed OpenStreetMap
      html += `<iframe id="map" src="https://www.openstreetmap.org/export/embed.html?bbox=${parseFloat(lng)-0.01},${parseFloat(lat)-0.01},${parseFloat(lng)+0.01},${parseFloat(lat)+0.01}&layer=mapnik&marker=${lat},${lng}"></iframe>`;

      result.innerHTML = html;

      // Get address with better error handling
      fetchAddress(lat, lng);
    }

    function fetchAddress(lat, lng) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

      fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`, {
        signal: controller.signal,
        headers: {
          'User-Agent': 'LocationFinderApp/1.0'
        }
      })
        .then(response => {
          clearTimeout(timeoutId);
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(data => {
          if (data.display_name) {
            const addressBox = `
              <div class="info-box" style="margin-top: 15px;">
                <div class="label">Address</div>
                <div class="value">${data.display_name}</div>
              </div>
            `;
            const grid = document.querySelector('.info-grid');
            if (grid) {
              grid.innerHTML += addressBox;
            }
          }
        })
        .catch(err => {
          console.log('Could not fetch address:', err);
          // Silently fail - address is optional
        });
    }

    function showError(error) {
      const loading = document.getElementById('loading');
      const result = document.getElementById('result');
      
      loading.style.display = 'none';
      result.style.display = 'block';

      let message = '';
      let showRetry = false;
      
      switch(error.code) {
        case error.PERMISSION_DENIED:
          message = "‚ùå Permission denied. Please allow location access in your browser settings and try again.";
          break;
        case error.POSITION_UNAVAILABLE:
          message = "‚ùå Location information is unavailable. Please check your GPS and internet connection.";
          showRetry = true;
          break;
        case error.TIMEOUT:
          message = "‚ùå Location request timed out. This might happen if GPS signal is weak. Please try again.";
          showRetry = true;
          break;
        default:
          message = "‚ùå An unknown error occurred. Please try again.";
          showRetry = true;
      }
      
      let errorHtml = `<div class="error">${message}</div>`;
      
      if (showRetry && retryCount < MAX_RETRIES) {
        errorHtml += `<button class="retry-btn" onclick="retryGetLocation()">üîÑ Retry (${retryCount + 1}/${MAX_RETRIES})</button>`;
      }
      
      result.innerHTML = errorHtml;
    }
  </script>
</body>
</html>